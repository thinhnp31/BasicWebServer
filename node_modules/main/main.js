"use strict";

exports.run = function(currentModule) {

	// Don't load anything if this module is not the main one
	if (currentModule.parent !== null) { return; }

	// adjust arguments as needed
	// valid call to this function:
	// run(module, [ pathToManMarkdown, argv ], fn)
	var args = Array.prototype.slice.call(arguments);
	args.shift(); // remove currentModule from the front
	var fn = args.pop(); // grab the function, should always be at the end
	var argv, pathToManMarkdown;

	// should only be two
	args.forEach(function(arg) {
		if (arg instanceof Array) { argv = arg; }
		if (typeof arg === 'string') { pathToManMarkdown = arg; }
	});

	// read the markdown file if one was provided
	if (!pathToManMarkdown) { readDone(); }
	else {
		require('fs').readFile(pathToManMarkdown, 'utf8', function(error, md) {
			if (error) { throw error; }
			readDone(md);
		});
	}

	function readDone(markdown) {
		var $ = require('./tools').load(
			argv || process.argv.slice(2), markdown);

		fn($);
	}
};
